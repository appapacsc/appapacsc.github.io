define(["jquery","underscore"],function($,_){"use strict";function calcBase(options){return config=$.extend(config,options),{init:init,getTemplate:getTemplate,loadJSON:loadJSON,getTemplateByPath:getTemplateByPath,wliveLinkHandling:wliveLinkHandling}}var wLiveContainer,config={templatePrefix:"dist"},widget={},widgetConfig={},jsonPromises=[],loadJSON=function(){var def=new $.Deferred,jsonCalls=[];if(wLiveContainer=$.find(".wlive-container"),wLiveContainer.length>0){var identifier=1,tmpObj={};_.each(config.endpoints,function(item){if(tmpObj={},item.path.indexOf("/bin/getJsonRates")<0&&"appconfig"!=item.name){var appFileName=item.path.match(/[^\/]+$/)[0],newappFIleName="wl-"+appFileName,filePath=item.path.replace(appFileName,newappFIleName);tmpObj.path=filePath}else tmpObj.path=item.path;tmpObj["data-type"]="json",tmpObj.JsonCallBack="callback_"+identifier,jsonCalls.push(tmpObj),identifier+=1})}else{var identifierConfig=4,tmpObj={};_.each(config.endpoints,function(item){var tmpObj={};tmpObj.path=item.path,tmpObj["data-type"]=item["data-type"],tmpObj.JsonCallBack="callback_"+identifierConfig,jsonCalls.push(tmpObj),identifierConfig+=1})}return $.each(jsonCalls,function(index,value){var settings={url:value.path,dataType:value["data-type"],cache:!1,timeout:1e4,jsonpCallback:value.JsonCallBack};jsonPromises.push($.ajax(settings).done(function(result){widgetConfig[config.endpoints[index].name]=result.data}).fail(function(){$(".js-error-msg").html("We're experiencing Technical Difficulties. Please try after some time"),$(".js-error-component").slideDown(),$("html, body").animate({scrollTop:$(".js-error-component").offset().top},1e3)}))}),$.when.apply($,jsonPromises).done(function(){def.resolve()}),def.promise()},loadTemplate=function(){var def=new $.Deferred,templateCalls=[],templatePromises=[];if(!config.templates)throw new Error("Missing result tempalte");return wLiveContainer.length>0?(_.each(config.templates,function(item){var indexPath=item.path.indexOf("/content"),serveletPath="/bin/getAsset?url=",finalPath=[item.path.slice(0,indexPath),serveletPath,item.path.slice(indexPath)].join(""),tempObjHtml={};tempObjHtml.relativePath=item.path,tempObjHtml.finalPath=finalPath,templateCalls.push(tempObjHtml)}),$.each(templateCalls,function(index,value){templatePromises.push($.ajax({url:value.finalPath,dataType:"json",jsonCallback:"callback"}).done(function(data){widget[value.relativePath]=_.template(data.data)}).fail(function(jqXHR,exception){$(".js-error-msg").html("We're experiencing Technical Difficulties. Please try after some time"),$(".js-error-component").slideDown(),$("html, body").animate({scrollTop:$(".js-error-component").offset().top},1e3)}))})):(_.each(config.templates,function(item){templateCalls.push(item.path)}),$.each(templateCalls,function(index,value){templatePromises.push($.ajax({url:value,beforeSend:function(xhr){xhr.url=value}}).done(function(data){widget[value]=_.template(data)}).fail(function(){$(".js-error-msg").html("We're experiencing Technical Difficulties. Please try after some time"),$(".js-error-component").slideDown(),$("html, body").animate({scrollTop:$(".js-error-component").offset().top},1e3)}))})),$.when.apply($,templatePromises).done(function(){def.resolve()}),def.promise()},getTemplate=function(templateIndex){return wLiveContainer.length>0&&setTimeout(function(){var container=$(".calc-body").next();wliveLinkHandling(container)},1e3),"function"==typeof widget[config.templates[templateIndex].path]?widget[config.templates[templateIndex].path]:"function"==typeof widget.templates[config.templates[templateIndex].path]?widget[config.templates[templateIndex].path]:void 0},getTemplateByPath=function(templatePath){if(wLiveContainer.length>0&&setTimeout(function(){var container=$(".calc-body").next();wliveLinkHandling(container)},1e3),"function"==typeof widget[templatePath])return widget[templatePath]},wliveLinkHandling=function(container){$(container).find("a").each(function(){processLinkHandling(this)})},processLinkHandling=function(field){var matchFound=!1;for(var i in widgetConfig.wlmapping)for(var j in widgetConfig.wlmapping[i])if($(field).attr("href").indexOf(widgetConfig.wlmapping[i][j])>-1){matchFound=!0;var dataTarget=i.split("|"),attrType=dataTarget[0],attrValue=dataTarget[1];$(field).attr(attrType,attrValue)}if(!matchFound){var appendUrl=$(field).attr("href");appendUrl+="?appAction=exit",$(field).attr("target","_blank"),$(field).attr("href",appendUrl)}},init=function(){var def=new $.Deferred,deferreds=[],loadWidgetJson=loadJSON();deferreds.push(loadWidgetJson);var loadWidgetTemplate=loadTemplate();return deferreds.push(loadWidgetTemplate),$.when.apply($,deferreds).done(function(){def.resolve(widgetConfig)}),def.promise()};return calcBase});