define(["jquery","underscore"],function(){"use strict";function formCore(options){return config=$.extend(config,options),{validationTriggered:validationTriggered,getErroArray:getErroArray,pageValidation:pageValidation,formatCurrency:formatCurrency,getFormFieldValue:getFormFieldValue,getSelectorJson:getSelectorJson,getResult:getResult}}var inValidFields=[],config={},resultsArray=[],analyticsResult={},labelChange=[];$(document).on("blur keyup",".js-validation",function(){validationTriggered(this)}),$(document).on("click",".js-selected",function(evt){var tileID=$(this).attr("name"),selJsonObj=config.result,selType=$(this).attr("type"),selValueArray=[];if("radio"==selType){var tempselValue=$('[name="'+tileID+'"]:checked').val();tempselValue=tempselValue.replace(/^[ ]+|[ ]+$/g,""),tempselValue=tempselValue+" ("+tileID.split("_")[1]+")",selValueArray.push(tempselValue)}else{var tempselValue=$("input[name="+tileID+"]").serializeArray();$.each(tempselValue,function(index,value){selValueArray.push(value.value+" ("+tileID.split("_")[1]+")")})}var resultDiv,selObj={},allNextClasses=$("."+tileID).nextAll();$.each(allNextClasses,function(index,value){$(value).hide()}),$.each(selJsonObj,function(index,value){"sel_"+value.tilediv===tileID&&(selObj=value)}),$.isEmptyObject(selObj)||$.each(selObj.multiLabelConditions,function(index,value){var difference=!1,multiArray=value.tilelabels;multiArray.length==selValueArray.length&&($.each(multiArray,function(index,value){$.inArray(value,selValueArray)<0&&(difference=!0)}),difference||(resultDiv=value.resultDivs))}),resultsArray=[],$.isArray(resultDiv)?$.each(resultDiv,function(i,val){resultsArray.push(val)}):$(".sel_"+resultDiv).slideDown("fast",function(){var scrolltop=calcOffset(".sel_"+resultDiv);$("body, html").animate({scrollTop:scrolltop},300)})});var calcOffset=function(targetEl){var headerH=0,stickyH=0,stickyMargin=12,targetMargin=24;headerH=$(".logo-bar").height(),stickyH=$(".simple-sticky-nav").height();var offset=$(targetEl).length>0?$(targetEl).offset().top:0;return $(".fixedbar").length>0&&(offset+=headerH),$(".simple-sticky-nav-fixed").length>0&&(offset+=stickyH,offset+=stickyMargin),offset-=headerH,offset-=stickyH,offset-=headerH+stickyH+stickyMargin+targetMargin},getSelectorJson=function(){var selectorJson=JSON.parse($(".calculator-body").attr("data-logic"));config=$.extend(config,selectorJson)},getResult=function(){return resultsArray},validateFailed=function(errorMsg,changeField){$($($(changeField).parents()[1])).addClass("alert-form has-danger"),void 0!=$(changeField).attr("id")?($("."+$(changeField).attr("id")).html(errorMsg),inValidFields.push($(changeField).attr("id"))):($("."+$(changeField).attr("name")).html(errorMsg),inValidFields.push($(changeField).attr("name")))},validatePassed=function(changeField,value){void 0!=$(changeField).attr("id")?($("."+$(changeField).attr("id")).html(""),inValidFields=jQuery.grep(inValidFields,function(value){return value!=$(changeField).attr("id")})):($("."+$(changeField).attr("name")).html(""),inValidFields=jQuery.grep(inValidFields,function(value){return value!=$(changeField).attr("name")})),$($($(changeField).parents()[1])).removeClass("alert-form has-danger"),analyticsObject(changeField,value)},getErroArray=function(){var uniqueArray=inValidFields.filter(function(elem,index,self){return index==self.indexOf(elem)});return uniqueArray},formatCurrency=function(number,places,symbol,thousand,decimal){number&&"string"==typeof number&&(number=parseInt(number,10)),places=isNaN(places=Math.abs(places))?2:places,symbol=void 0!==symbol?symbol:"$",thousand=thousand||",",decimal=decimal||".";var negative=number<0?"-":"",i=parseInt(number=Math.abs(+number||0).toFixed(places),10)+"",j=(j=i.length)>3?j%3:0;return symbol+negative+(j?i.substr(0,j)+thousand:"")+i.substr(j).replace(/(\d{3})(?=\d)/g,"$1"+thousand)+(places?decimal+Math.abs(number-i).toFixed(places).slice(2):"")};$(document).on("click",".btn-minus",function(){var elemArray=$(this).siblings(),sliderField=elemArray[0],a=JSON.parse($(sliderField).attr("data-validation")),depenedantsVal=$(sliderField).val();depenedantsVal!=a.validationType.min&&(depenedantsVal-=1,$(sliderField).val(depenedantsVal))}),$(document).on("click",".btn-plus",function(){var elemArray=$(this).siblings(),sliderField=elemArray[1],a=JSON.parse($(sliderField).attr("data-validation")),depenedantsVal=parseInt($(sliderField).val());depenedantsVal<a.validationType.max&&(depenedantsVal+=1,$(sliderField).val(depenedantsVal))});var getFormFieldValue=function(){var formFieldsValue={},inputFields=$(":input");return $.each(inputFields,function(index,value){void 0!=$(value).attr("id")&&""!=$(value).attr("id")&&null!=$(value).attr("id")?"wg"==$(value).attr("id").split("-")[0]&&"radio"!=$(value).attr("type")&&(formFieldsValue[$(value).attr("id")]=$(value).val()):void 0!=$(value).attr("name")&&""!=$(value).attr("name")&&null!=$(value).attr("name")&&"wg"==$(value).attr("name").split("-")[0]&&("radio"==$(value).attr("type")?formFieldsValue[$(value).attr("name")]=$("input:radio[name="+$(value).attr("name")+"]:checked").val():formFieldsValue[$(value).attr("name")]=$(value).val())}),formFieldsValue};$(document).on("change",".js-Change",function(){eventHandler(this)}),$(document).on("click",".js-Click",function(){eventHandler(this)});var eventHandler=function(eventField){var eventBindings={};if(void 0!=$(eventField).attr("data-events")){eventBindings=JSON.parse($(eventField).attr("data-events"));var fieldId=$(eventField).attr("name");if("radio"==$(eventField).attr("type"))var currentValue=$("input:radio[name="+fieldId+"]:checked").val();else if("checkbox"==$(eventField).attr("type"))var currentValue=$("input[name="+fieldId+"]").serializeArray();else var currentValue=$(eventField).val();if("on"==eventBindings.hideStatus){var hideField=[];$.each(eventBindings.hide,function(index,value){var triggerID="id-"+value.hideComponentSelection;if(jQuery.isArray(currentValue))if(0===currentValue.length)$("."+triggerID).slideDown();else{var selectedValues=[];$.each(currentValue,function(index,checkBoxVal){selectedValues.push(checkBoxVal.value),checkBoxVal.value==value.eventVal?($("."+triggerID).slideUp(),value.prepop&&$("."+triggerID).find("input").val(value.prepop)):selectedValues.indexOf(value.eventVal)<0&&$("."+triggerID).slideDown()})}else currentValue==value.eventVal||""==currentValue?(hideField[triggerID]=!0,$("."+triggerID).slideUp(),value.prepop&&$("."+triggerID).find("input").val(value.prepop)):hideField[triggerID]||$("."+triggerID).slideDown()})}if("on"==eventBindings.showStauts){var showField=[];$.each(eventBindings.show,function(index,value){var triggerID="id-"+value.showComponentSelection;if(jQuery.isArray(currentValue))if(0===currentValue.length)$("."+triggerID).slideUp();else{var selectedValues=[];$.each(currentValue,function(index,checkBoxVal){selectedValues.push(checkBoxVal.value),checkBoxVal.value==value.eventValShow?($("."+triggerID).slideDown(),value.prepop&&$("."+triggerID).find("input").val(value.prepop)):selectedValues.indexOf(value.eventValShow)<0&&$("."+triggerID).slideUp()})}else currentValue==value.eventValShow||""==currentValue?(showField[triggerID]=!0,$("."+triggerID).slideDown(),value.prepop&&$("."+triggerID).find("input").val(value.prepop)):showField[triggerID]||$("."+triggerID).slideUp()})}if("on"==eventBindings.labelStatus&&$.each(eventBindings.label,function(index,value){var tempVal=value,fieldIdentifier="id-"+value.changeSelectedLabel;if(jQuery.isArray(currentValue))if(0===currentValue.length){var fieldDiv=$("."+fieldIdentifier);$.each(fieldDiv,function(index,value){labelChange[fieldIdentifier]&&$(value).find("div:first label span").html(labelChange[fieldIdentifier])})}else{var selectedValues=[];$.each(currentValue,function(index,checkBoxVal){if(selectedValues.push(checkBoxVal.value),checkBoxVal.value==tempVal.onVal){var fieldDiv=$("."+fieldIdentifier);$.each(fieldDiv,function(index,value){labelChange[fieldIdentifier]||(labelChange[fieldIdentifier]=$(value).find("label span").html()),$(value).find("div:first label span").html(tempVal.newLabel),tempVal.prepop&&$(fieldDiv).find("input").val(tempVal.prepop)})}else if(selectedValues.indexOf(value.onVal)<0){var fieldDiv=$("."+fieldIdentifier);$.each(fieldDiv,function(index,value){labelChange[fieldIdentifier]&&$(value).find("div:first label span").html(labelChange[fieldIdentifier])})}})}else if(currentValue==tempVal.onVal||""==currentValue){var fieldDiv=$("."+fieldIdentifier);$.each(fieldDiv,function(index,value){labelChange[fieldIdentifier]||(labelChange[fieldIdentifier]=$(value).find("label span").html()),$(value).find("div:first label span").html(tempVal.newLabel),tempVal.prepop&&$(fieldDiv).find("input").val(tempVal.prepop)})}else{var fieldDiv=$("."+fieldIdentifier);$.each(fieldDiv,function(index,value){labelChange[fieldIdentifier]&&$(value).find("div:first label span").html(labelChange[fieldIdentifier])})}}),"on"==eventBindings.placeholderStatus){$.each(eventBindings.updatePlaceholder,function(index,value){var placeholderID="id-"+value.placeholderCompSelection;jQuery.isArray(currentValue)?$.each(currentValue,function(index,checkBoxVal){checkBoxVal.value==value.placeholderEvent&&$("."+placeholderID).find("input").attr("placeholder",value.placeholderValue)}):currentValue!=value.placeholderEvent&&""!=currentValue||$("."+placeholderID).find("input").attr("placeholder",value.placeholderValue)})}}},pageData=function(pageIDs){var userData=getFormFieldValue(),calculationObj={};for(var key in pageIDs)calculationObj[key]=userData[pageIDs[key]];return calculationObj},processAnalyticsData=function(){if(genralAnalyticsObj(),window.pageDetails){for(var key in analyticsResult)window.pageDetails[key]=analyticsResult[key];var tempEventKey=window.pageDetails.siteBrand+":"+window.pageDetails.siteExperience+"_"+analyticsResult.pageType+"_"+analyticsResult.calculatorName+"_"+window.pageDetails.pageName;window.pageDetails.eventKey=tempEventKey}},pageValidation=function(pageIDs){for(var def=new $.Deferred,inputFields=$(":input"),i=0,len=inputFields.length;i<len;i++)validationTriggered(inputFields[i]);if(getErroArray().length<=0){var userData={};jQuery.isEmptyObject(pageIDs)?jQuery.error("No page ID mapping was found. Please pass the pageID mapping as an object. See example in sample-calculator.js, check for pageIDs in sample-calculator.js"):userData.UserInputData=pageData(pageIDs),def.resolve(userData)}else def.reject(getErroArray());return processAnalyticsData(),def.promise()},genralAnalyticsObj=function(){var data=JSON.parse($(".calculator-body").attr("data-analytcis")),regex=/([!"\(\)\*;<>?@\[\]\\^`\{\}|~&=+‘“\/_$%'#\-,\s])/g;if("on"==data["enable-analytics"])for(var key in data.analytics){var value=data.analytics[key];analyticsResult[key]=value.replace(regex,"-").toLowerCase()}},analyticsObject=function(changeField,value){var data=JSON.parse($(changeField).attr("data-validation")),analyticsDetails=data.analytics,regex=/([!"\(\)\*;<>?@\[\]\\^`\{\}|~&=+:‘“\/_$%'#\-,\s])/g;if("on"==analyticsDetails["analytics-required"]&&""!=value&&null!=value&&void 0!=value){var analyticsKey=analyticsDetails["analytics-key"];analyticsResult[analyticsKey]="number"!==$(changeField).attr("type")?value.replace(regex,"-").toLowerCase():value}},validationTriggered=function(changeField){$(changeField).attr("id");if(void 0!=$(changeField).attr("data-validation")){var fieldValidationObj=JSON.parse($(changeField).attr("data-validation")),fieldType=$(changeField).attr("type"),value="";if("radio"==fieldType)value=$("input:radio[name="+$(changeField).attr("name")+"]:checked").val();else if("checkbox"==fieldType){var tempCheckVal=$("input[name="+$(changeField).attr("name")+"]").serializeArray();value=0===tempCheckVal.length?null:"pass"}else value=$(changeField).val();for(var i in fieldValidationObj.validationType){var errorCount=0;if("required"==i&&"on"==fieldValidationObj.validationType[i]&&$(changeField).is(":visible")){if(null==value||void 0==value||""==value||"Choose"==value||"Select"==value){validateFailed(fieldValidationObj.validationMsg[i+"ErrMsg"],changeField);break}validatePassed(changeField,value)}else validatePassed(changeField,value);if("maxmin"==i&&"on"==fieldValidationObj.validationType[i]&&$(changeField).is(":visible")){var unformatNumber=value.replace(/\,/g,"");if(parseInt(unformatNumber)>parseInt(fieldValidationObj.validationType.max)||parseInt(unformatNumber)<parseInt(fieldValidationObj.validationType.min)){validateFailed(fieldValidationObj.validationMsg[i+"ErrMsg"],changeField);break}validatePassed(changeField,value)}else validatePassed(changeField,value);if("pattern"==i&&""!=fieldValidationObj.validationType[i]&&"on"==fieldValidationObj.validationType.patternrequired&&$(changeField).is(":visible")){var pattern=fieldValidationObj.validationType[i],regex=new RegExp(pattern),match=regex.test(value);if(!match){validateFailed(fieldValidationObj.validationMsg[i+"ErrMsg"],changeField);break}validatePassed(changeField,value)}else validatePassed(changeField,value);errorCount+=1}}};return formCore});